#!/usr/bin/python

import libuser
import os
#import pyslurm

import subprocess
from time import sleep

wait_time = 5
#default_group = 'shavak'
default_group = 'adm'
default_passwd = 'p@$$word'

# define the countdown func.
def countdown(t):
    while t:
        mins, secs = divmod(t, 60)
        timer = '{:02d}:{:02d}'.format(mins, secs)
        print(timer, end="\r")
        sleep(1)
        t -= 1
    print('\nProceeding\n')

def setPassword(userName:str, password:str):
    p = subprocess.Popen([ "/usr/sbin/chpasswd" ], universal_newlines=True, shell=False,\
			 stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    (stdout, stderr) = p.communicate(userName + ":" + password + "\n")
    assert p.wait() == 0
    if stdout or stderr:
        raise Exception("Error encountered changing the password!")
    p = subprocess.Popen(["/usr/bin/passwd", "--expire", userName])

if __name__ == '__main__':
    print("--------- Initializing.")
    admin = libuser.admin()
    sleep(1)
    username = input("Enter new username: ")

    print(f"--------- Adding new user {username} in {wait_time} seconds. Press Ctrl-C to abort.")
    countdown(wait_time)

    print(f"--------- Creating a new user ({username}).")
    new_user = admin.initUser(username)

    print("--------- Adding the user.")
    new_homedir = '/home/' + username
    new_user[libuser.HOMEDIRECTORY] = new_homedir
    print("Set home directory to " + new_user[libuser.HOMEDIRECTORY][0])

    new_user[libuser.LOGINSHELL] = '/bin/bash'
    print("Set login shell to " + new_user[libuser.LOGINSHELL][0])

    #Adds the user and sets the default password
    admin.addUser(new_user)
    setPassword(username, default_passwd)

    print("--------- Grepping for the user.")
    os.system(f"grep {username} /etc/passwd /etc/group /etc/shadow /etc/gshadow")

    try:
        dir = new_user.get(libuser.HOMEDIRECTORY)
        print("--------- Looking at user's directory.")
        os.system("ls " + dir[0])
    except:
        pass

    print(f"--------- Adding {username} to group: "+default_group)
    os.system(f'usermod -g {default_group} {username}')

    print(f"--------- Adding the user to SLURM account")

    #...

    print("---------- Finished.")
